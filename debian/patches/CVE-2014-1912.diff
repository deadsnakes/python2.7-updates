
# HG changeset patch
# User Benjamin Peterson <benjamin@python.org>
# Date 1389671978 18000
# Node ID 87673659d8f7ba1623cd4914f09ad3d2ade034e9
# Parent  2631d33ee7fbd5f0288931ef37872218d511d2e8
complain when nbytes > buflen to fix possible buffer overflow (closes #20246)

Index: python2.7-2.7.3/Lib/test/test_socket.py
===================================================================
--- python2.7-2.7.3.orig/Lib/test/test_socket.py	2014-02-27 09:13:57.537313146 -0500
+++ python2.7-2.7.3/Lib/test/test_socket.py	2014-02-27 09:13:57.533313146 -0500
@@ -1515,6 +1515,16 @@
 
     _testRecvFromIntoMemoryview = _testRecvFromIntoArray
 
+    def testRecvFromIntoSmallBuffer(self):
+        # See issue #20246.
+        buf = bytearray(8)
+        self.assertRaises(ValueError, self.cli_conn.recvfrom_into, buf, 1024)
+
+    def _testRecvFromIntoSmallBuffer(self):
+        with test_support.check_py3k_warnings():
+            buf = buffer(MSG*2048)
+        self.serv_conn.send(buf)
+
 
 TIPC_STYPE = 2000
 TIPC_LOWER = 200
Index: python2.7-2.7.3/Modules/socketmodule.c
===================================================================
--- python2.7-2.7.3.orig/Modules/socketmodule.c	2014-02-27 09:13:57.537313146 -0500
+++ python2.7-2.7.3/Modules/socketmodule.c	2014-02-27 09:13:57.533313146 -0500
@@ -2675,6 +2675,10 @@
     if (recvlen == 0) {
         /* If nbytes was not specified, use the buffer's length */
         recvlen = buflen;
+    } else if (recvlen > buflen) {
+        PyErr_SetString(PyExc_ValueError,
+                        "nbytes is greater than the length of the buffer");
+        goto error;
     }
 
     readlen = sock_recvfrom_guts(s, buf.buf, recvlen, flags, &addr);
